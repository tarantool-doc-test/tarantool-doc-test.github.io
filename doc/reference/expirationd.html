




<!doctype html>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Package expirationd</title>
    <link rel="shortcut icon" href="/theme/favicon.ico" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.6.7-521-g0d75d50',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/translations.js"></script>
    <script type="text/javascript" src="../_static/jquery.pin.min.js"></script>
    <script type="text/javascript" src="../_static/headers.js"></script>
    <link rel="stylesheet" href="/theme/design.css">
    <link rel="stylesheet" href="/theme/pygmentize.css">
    <link rel="stylesheet" href="../_static/sphinx_design.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
     
    <!--[if lt IE 9]>
      <script src="/js/ie8.js"></script>
      <link rel="stylesheet" href="/theme/ie8.css" />
    <![endif]-->
    <script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-22120502-1', 'auto');
  ga('send', 'pageview');
</script>

<!-- Rating@Mail.ru counter -->
<script type="text/javascript">
  var _tmr = _tmr || [];
  _tmr.push({id: "2284916", type: "pageView", start: (new Date()).getTime()});
  (function (d, w) {
    var ts = d.createElement("script"); ts.type = "text/javascript"; ts.async = true;
    ts.src = (d.location.protocol == "https:" ? "https:" : "http:") + "//top-fwz1.mail.ru/js/code.js";
    var f = function () {var s = d.getElementsByTagName("script")[0]; s.parentNode.insertBefore(ts, s);};
    if (w.opera == "[object Opera]") { d.addEventListener("DOMContentLoaded", f, false); } else { f(); }
  })(document, window);
</script>
<noscript>
  <div style="position:absolute;left:-10000px;">
    <img src="//top-fwz1.mail.ru/counter?id=2284916;js=na" style="border:0;"
         height="1" width="1" alt="Рейтинг@Mail.ru" />
  </div>
</noscript>
<!-- //Rating@Mail.ru counter -->


  </head>
  
  <body class="p-cols_design">
  
    <div class="b-wrapper">
      <!-- HEADER > -->
      <header class="b-header">
        <div class="b-header-wrapper">
          <nav class="b-header_menu">
            
  <ul class="b-menu">
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org" class="b-menu-item-url">Overview</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://try.tarantool.org" class="b-menu-item-url">Try</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/doc/" class="b-menu-item-url p-active">Documentation</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/download.html" class="b-menu-item-url">Download</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/careers.html" class="b-menu-item-url">Careers</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://rocks.tarantool.org" class="b-menu-item-url">Rocks</a>
        
      </li>
    
  </ul>

          </nav>
        </div>
      </header>
      <!-- < HEADER -->

      <div class="b-content b-clearbox">
        
  
  <section class="b-lightgray_block b-documentation_top b-clearbox p-documentation_in">
  
    <div class="b-block-wrapper">
      <h2 class="b-section-title">Package <cite>expirationd</cite></h2>
      
    </div>
  </section>
  <div class="b-cols_content b-clearbox">
    <div class="b-cols_content_left">
      
      
<form id="searchbox" role="search" class="search b-search" action="../search.html" method="get">
  <input class="b-search-text" name="q" type="text"/ placeholder="Search the manual">
  <input class="b-search-but" type="submit" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>


      
      <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../book/index.html">User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Reference Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="box.html">Package <cite>box</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="box_error.html">Package <cite>box.error</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="clock.html">Package <cite>clock</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="console.html">Package <cite>console</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="csv.html">Package <cite>csv</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="digest.html">Package <cite>digest</cite></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Package <cite>expirationd</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="fiber.html">Package <cite>fiber</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="fiber-ipc.html">Package <cite>fiber-ipc</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="fio.html">Package <cite>fio</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="fun.html">Package <cite>fun</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="jit.html">Package <cite>jit</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="json.html">Package <cite>json</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="log.html">Package <cite>log</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="msgpack.html">Package <cite>msgpack</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="net_box.html">Package <cite>net.box</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="pickle.html">Package <cite>pickle</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="shard.html">Package <cite>shard</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="socket.html">Package <cite>socket</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="strict.html">Package <cite>strict</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="tap.html">Package <cite>tap</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="tarantool.html">Package <cite>tarantool</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="uuid.html">Package <cite>uuid</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="yaml.html">Package <cite>yaml</cite></a></li>
<li class="toctree-l2"><a class="reference internal" href="other.html">Miscellaneous</a></li>
<li class="toctree-l2"><a class="reference internal" href="capi.html">Module C API</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dev_guide/index.html">Contributing</a></li>
</ul>

    </div>
    <div class="b-cols_content_right">
      <div class="b-cols_content_right-slot">
  

<div class="b-page_header">
  <ul class="b-path-list">
    <li class="b-path-list-item">
      <a href="/doc/" class="b-path-list-item-url">Documentation</a>
    </li>
  
    <li class="b-path-list-item">
      <a href="index.html" class="b-path-list-item-url">Reference Manual</a>
    </li>
  
    <li class="b-path-list-item"><span class="b-path_current">Package <cite>expirationd</cite></span></li>
  </ul>
</div>

<article class="b-article">
          
          
  <div class="section" id="package-expirationd">
<h1>Package <cite>expirationd</cite><a class="headerlink" href="#package-expirationd" title="Ссылка на этот заголовок">¶</a></h1>
<p>For a commercial-grade example of a Lua rock that works with Tarantool, let us
look at expirationd, which Tarantool supplies on <a class="reference external" href="https://github.com/tarantool/expirationd/blob/master/expirationd.lua">GitHub</a> with an Artistic license.
The expirationd.lua program is lengthy (about 500 lines), so here we will only
highlight the matters that will be enhanced by studying the full source later.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">task</span><span class="p">.</span><span class="n">worker_fiber</span> <span class="o">=</span> <span class="n">fiber</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">worker_loop</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>
<span class="n">log</span><span class="p">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">expiration: task %q restarted&quot;</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="o">...</span>
<span class="n">fiber</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">expirationd</span><span class="p">.</span><span class="n">constants</span><span class="p">.</span><span class="n">check_interval</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Whenever one hears &quot;daemon&quot; in Tarantool, one should suspect it's being done
with <a class="reference internal" href="fiber.html"><em>Package fiber</em></a>. The program is making a fiber and turning control over to it so
it runs occasionally, goes to sleep, then comes back for more.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">tuple</span> <span class="k">in</span> <span class="n">scan_space</span><span class="p">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="nb">pairs</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span> <span class="p">{</span><span class="n">iterator</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">index</span><span class="p">.</span><span class="n">ALL</span><span class="p">})</span> <span class="k">do</span>
<span class="o">...</span>
        <span class="k">if</span> <span class="n">task</span><span class="p">.</span><span class="n">is_tuple_expired</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">tuple</span><span class="p">)</span> <span class="k">then</span>
        <span class="n">task</span><span class="p">.</span><span class="n">expired_tuples_count</span> <span class="o">=</span> <span class="n">task</span><span class="p">.</span><span class="n">expired_tuples_count</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">task</span><span class="p">.</span><span class="n">process_expired_tuple</span><span class="p">(</span><span class="n">task</span><span class="p">.</span><span class="n">space_id</span><span class="p">,</span> <span class="n">task</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">tuple</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>The &quot;for&quot; instruction can be translated as &quot;iterate through the index of the
space that is being scanned&quot;, and within it, if the tuple is &quot;expired&quot; (that
is, if the tuple has a timestamp field which is less than the current time),
process the tuple as an expired tuple.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="c1">-- put expired tuple in archive</span>
<span class="kd">local</span> <span class="k">function</span> <span class="nf">put_tuple_to_archive</span><span class="p">(</span><span class="n">space_id</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">tuple</span><span class="p">)</span>
    <span class="c1">-- delete expired tuple</span>
    <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">space_id</span><span class="p">]:</span><span class="n">delete</span><span class="p">{</span><span class="n">tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]}</span>
    <span class="kd">local</span> <span class="n">email</span> <span class="o">=</span> <span class="n">get_field</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">archive_space_id</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="ow">and</span> <span class="n">email</span> <span class="o">~=</span> <span class="kc">nil</span> <span class="k">then</span>
        <span class="n">box</span><span class="p">.</span><span class="n">space</span><span class="p">[</span><span class="n">args</span><span class="p">.</span><span class="n">archive_space_id</span><span class="p">]:</span><span class="n">replace</span><span class="p">{</span><span class="n">email</span><span class="p">,</span> <span class="nb">os.time</span><span class="p">()}</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Ultimately the tuple-expiry process leads to <code class="docutils literal"><span class="pre">put_tuple_to_archive()</span></code>
which does a &quot;delete&quot; of a tuple from its original space, and an &quot;insert&quot;
of the same tuple into another space. Tarantool's &quot;replace&quot; function is
the same as an &quot;insert&quot; function without an error message if a tuple with
the same content already exists in the target space.</p>
<div class="highlight-lua"><div class="highlight"><pre><span class="k">function</span> <span class="nc">expirationd</span><span class="p">.</span><span class="nf">do_test</span><span class="p">(</span><span class="n">space_id</span><span class="p">,</span> <span class="n">archive_space_id</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>At this point, if the above explanation is worthwhile, it's clear that
<code class="docutils literal"><span class="pre">expirationd.lua</span></code> starts a background routine (fiber) which iterates through
all the tuples in a space, sleeps cooperatively so that other fibers can
operate at the same time, and - whenever it finds a tuple that has expired
- deletes it from this space and puts it in another space. Now the
&quot;<code class="docutils literal"><span class="pre">do_test()</span></code>&quot; function can be used to create some sample spaces, let the
daemon run for a while, and print results.</p>
<p>For those who like to see things run, here are the exact steps to get
expirationd through the test.</p>
<ol class="arabic simple">
<li>Get <code class="docutils literal"><span class="pre">expirationd.lua</span></code>. There are standard ways - it is after all part
of a <a class="reference external" href="https://luarocks.org/modules/rtsisyk/expirationd">standard rock</a>  - but for this purpose just copy the contents of
<a class="reference external" href="https://github.com/tarantool/expirationd/blob/master/expirationd.lua">expirationd.lua</a> to a default directory.</li>
<li>Start the Tarantool server as described before.</li>
<li>Execute these requests:</li>
</ol>
<div class="highlight-lua"><div class="highlight"><pre><span class="n">box</span><span class="p">.</span><span class="n">cfg</span><span class="p">{}</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">origin&#39;</span><span class="p">)</span>
<span class="n">a</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">first&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">tree&#39;</span><span class="p">,</span> <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">NUM&#39;</span><span class="p">}})</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">box</span><span class="p">.</span><span class="n">schema</span><span class="p">.</span><span class="n">space</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">archive&#39;</span><span class="p">)</span>
<span class="n">b</span><span class="p">:</span><span class="n">create_index</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">first&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nb">type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="s">tree&#39;</span><span class="p">,</span> <span class="n">parts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">STR&#39;</span><span class="p">}})</span>
<span class="n">expd</span> <span class="o">=</span> <span class="nb">require</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">expirationd&#39;</span><span class="p">)</span>
<span class="n">expd</span><span class="p">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="kc">true</span>
<span class="n">expd</span><span class="p">.</span><span class="n">do_test</span><span class="p">(</span><span class="s1">&#39;</span><span class="s">origin&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="s">archive&#39;</span><span class="p">)</span>
<span class="nb">os.exit</span><span class="p">()</span>
</pre></div>
</div>
<p>The database-specific requests (<code class="docutils literal"><span class="pre">cfg</span></code>, <code class="docutils literal"><span class="pre">space.create</span></code>, <code class="docutils literal"><span class="pre">create_index</span></code>)
should already be familiar. The key for getting the rock rolling is
<code class="docutils literal"><span class="pre">expd</span> <span class="pre">=</span> <span class="pre">require('expirationd')</span></code>. The &quot;<code class="docutils literal"><span class="pre">require</span></code>&quot; function is what reads in
the program; it will appear in many later examples in this manual, when it's
necessary to get a package that's not part of the Tarantool kernel. After the
Lua variable expd has been assigned the value of the expirationd package, it's
possible to invoke the package's <code class="docutils literal"><span class="pre">do_test()</span></code> function.</p>
<p>After a while, when the task has had time to do its iterations through the spaces,
<code class="docutils literal"><span class="pre">do_test()</span></code> will print out a report showing the tuples that were originally in
the original space, the tuples that have now been moved to the archive space, and
some statistics. Of course, expirationd can be customized to do different things
by passing different parameters, which will be evident after looking in more detail
at the source code.</p>
</div>


        </article>


<div class="b-page_over-tail">

    
    <a href="digest.html" class="b-prev">Package <cite>digest</cite></a>
    
    
    <a href="fiber.html" class="b-next">Package <cite>fiber</cite></a>
    
</div>


      </div>
    </div>
  </div>
  

      </div>
    </div>

    <!-- FOOTER > -->
    <footer class="b-footer">
      <div class="b-footer-wrapper">
        <nav class="b-footer_menu">
          
  <ul class="b-menu">
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org" class="b-menu-item-url">Overview</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://try.tarantool.org" class="b-menu-item-url">Try</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/doc/" class="b-menu-item-url p-active">Documentation</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/download.html" class="b-menu-item-url">Download</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://tarantool.org/careers.html" class="b-menu-item-url">Careers</a>
        
      </li>
    
      <li class="b-menu-item">
        
        <a href="http://rocks.tarantool.org" class="b-menu-item-url">Rocks</a>
        
      </li>
    
  </ul>

          <div class="b-footer-other">
            <a href="http://stable.tarantool.org">1.5 web site and downloads</a>
          </div>
        </nav>
      </div>
    </footer>
  <!-- < FOOTER -->
  </body>
</html>

